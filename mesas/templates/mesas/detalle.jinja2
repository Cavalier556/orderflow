{% extends "base.html" %}
{% block content %}

<div class="p-2 md:px-24">
    <div class="pb-8">
        <h1 class="text-3xl font-bold flex items-center gap-2"><a href="/mesas/"
                class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground h-10 w-10"><svg
                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-arrow-left h-5 w-5">
                    <path d="m12 19-7-7 7-7"></path>
                    <path d="M19 12H5"></path>
                </svg></a>Mesa: {{mesa.numero}}</h1>
    </div>
    <div class="container-center">
        <div>
            <div class="bg-white border border-gray-200 shadow-sm rounded p-6 mb-6">
                <h3 class="text-2xl font-semibold leading-none tracking-tight">Agregar más platos</h3>
                <form class="pt-6 gap-4 flex flex-col md:flex-row" hx-swap="outerHTML" hx-target="#tabla-detalles"
                    hx-select="#tabla-detalles" hx-post="/mesas/{{mesa.id}}/add_plato/"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                    <select name="plato_nuevo" id="plato_nuevo" class="shadow border rounded py-2 px-3">
                        <option disabled selected value> -- -- </option>
                        {% for plato in all_platos %}
                        <option value="{{plato.id}}" data-price="{{plato.precio}}">{{plato.nombre}}</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="precio"
                        class="form-control shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        name="precio" placeholder="Precio" required />
                    <input type="text" id="cantidad"
                        class="form-control shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        name="cantidad" placeholder="Cantidad" required />
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">Agregar</button>

                </form>
            </div>

            <script>
                var select = document.getElementById("plato_nuevo");
                var input = document.getElementById("precio");
                var input2 = document.getElementById("cantidad");

                function cambiarPrecio() {
                    let option = select.selectedOptions[0];
                    input.value = option.dataset.price || '';
                    input2.value = "1"
                }

                select.addEventListener('change', cambiarPrecio);
            </script>
        </div>
        <div class="grid md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-4">
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm" id="tabla-detalles">
                    <h3 class="text-2xl font-semibold leading-none tracking-tight p-6">Detalle de mesa</h3>
                    <div class="overflow-x-auto w-screen md:w-full">
                        <table class="table table-auto overflow-scroll w-full">
                            <thead>
                                <tr class="border-b border-gray-200 transition-colors hover:bg-gray-300/50">
                                    <th class="px-4 py-2 font-medium text-gray-700 text-left">Descripcion</th>
                                    <th class="px-4 py-2 font-medium text-gray-700">Precio</th>
                                    <th class="px-4 py-2 font-medium text-gray-700 text-left">Cantidad</th>
                                    <th class="px-4 py-2 font-medium text-gray-700 text-left">Borrar</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plato in platos %}
                                <tr class="border-b border-gray-200 transition-colors hover:bg-gray-200/50">
                                    <td class="px-4 py-2">{{ plato.plato.nombre }} </td>
                                    <td class="px-4 py-2">{{ plato.precio }}</td>
                                    <td class="px-4 py-2">{{ plato.cantidad }}</td>
                                    <td class="px-4 py-2">
                                        <button hx-confirm="¿Desea borrar?"
                                            hx-delete="/mesas/{{mesa.id}}/detalle/{{plato.id}}/delete_plato/"
                                            hx-target="#tabla-detalles" hx-select="#tabla-detalles" hx-swap="innerHTML"
                                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20"
                                                height="20" viewBox="0 0 30 30">
                                                <path
                                                    d="M 13 3 A 1.0001 1.0001 0 0 0 11.986328 4 L 6 4 A 1.0001 1.0001 0 1 0 6 6 L 24 6 A 1.0001 1.0001 0 1 0 24 4 L 18.013672 4 A 1.0001 1.0001 0 0 0 17 3 L 13 3 z M 6 8 L 6 24 C 6 25.105 6.895 26 8 26 L 22 26 C 23.105 26 24 25.105 24 24 L 24 8 L 6 8 z">
                                                </path>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-right pt-4 pb-6 px-6  mt-4">
                        <p class="text-xl font-bold">Total: S/{{ total }}</p>
                    </div>
                </div>
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm p-6">
                    <form action="/mesas/{{mesa.id}}/imprimir/" class="">
                        <h3 class="text-xl font-semibold leading-none tracking-tight pb-6">Generar ticket</h3>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">Imprimir</button>
                    </form>
                </div>
            </div>

            <div class="md:col-span-1 rounded-lg border border-gray-200 bg-white shadow-sm p-6" id="div-pagos"
                hx-swap-oob="true">
                {% if pagos %}
                <div class="flex flex-col mb-4">
                    <h3 class="text-xl font-semibold leading-none tracking-tight">Lista de Pagos</h3>
                    <table class="my-2">
                        {% for pago in pagos %}
                        <tr class="border-b border-gray-200 transition-colors hover:bg-gray-200/50">
                            <td class="px-4 py-2">{{ pago.tipo.nombre }} </td>
                            <td class="px-4 py-2">{{ pago.monto }}</td>
                            <td class="px-4 py-2 text-right">
                                <button hx-confirm="¿Desea borrar?"
                                    hx-delete="/mesas/{{mesa.id}}/pago/{{pago.id}}/delete_pago/"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                    class="cursor-pointer inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md bg-red-600 text-white hover:bg-red-600/90 h-8 w-8">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="lucide lucide-trash2 h-4 w-4">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                        <line x1="10" x2="10" y1="11" y2="17"></line>
                                        <line x1="14" x2="14" y1="11" y2="17"></line>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                    <span class="text-right pr-2 border-b-1 font-semibold" id="monto_restante" hx-swap-oob="true">Falta
                        pagar:
                        {{restante}}</span>
                </div>
                {% endif %}

                {% if restante == 0 %}
                <button hx-get="/mesas/{{mesa.id}}/archivar/" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded">Archivar</button>
                {% else %}
                <form hx-post="/mesas/{{mesa.id}}/add_pago/" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-target="#div-pagos" hx-select="#div-pagos">
                    <h3 class="text-xl font-semibold leading-none tracking-tight my-4">
                        Registrar Pagos
                    </h3>

                    <div class="flex flex-col space-y-2" id="pagos">
                        <select name="tipopago" id="tipopago" class="shadow border rounded py-2 px-3">
                            {% for tipo_pago in tipopagos %}
                            <option value="{{tipo_pago.id}}">{{tipo_pago.nombre}}</option>
                            {% endfor %}
                        </select>
                        <input type="number" step="0.01" max="{{restante}}" id="monto"
                            class="form-control shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            name="monto" placeholder="{{restante}}" required />
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">Agregar</button>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}